<!DOCTYPE html>
<html>
	<head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<title>Register | TEDi BEAR</title>
        <link rel="icon" type="image/x-icon" href="../img/logo-blue-short.png"/>

        <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

		<!-- Start Load CSS -->
		<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,700&subset=latin,greek' rel='stylesheet' type='text/css'>
		<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
		<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
		<link rel="stylesheet" href="../css/app.css">
		<!-- End Load CSS -->

	</head>
	<body >

		<section id="register">
			<div class="container">
				<div class="row justify-content-center">
					<div class="col col-xs-10 col-sm-8 col-md-6">

						<div class="logo">
							<img src="../img/logo-blue.png" alt="TEDi Logo" class="img-responsive" />
						</div>

						<div id="loginmsg" class="alert alert-danger" role="alert">
							Invalid credentials
						</div>

						<div id="wait" class="alert alert-primary" role="alert">
							We validate your credentials
							<i class="fa fa-circle-o-notch fa-1x fa-spin px-1"></i>
						</div>

						<form method="post">

							<legend>Register to TEDi BEAR</legend>

							<div class="form-group">
								<label for="email">Email*</label>
								<input type="email" id="email" required name="_email" class="form-control"/>
							</div>

							<div class="form-group">
								<label for="password">Password*</label>
								<input type="password" id="password" required name="_password" class="form-control"/>
							</div>

                            <div class="form-group container">
                                <div class="row">
                                    <div class="col-6 pl-0">
        								<label for="firstname">First Name</label>
        								<input type="text" id="firstname" name="_firstname" class="form-control"/>
                                    </div>
                                    <div class="col-6 pr-0">
                                        <label for="lastname">Last Name</label>
        								<input type="text" id="lastname" name="_lastname" class="form-control"/>
                                    </div>
                                </div>
							</div>

                            <div class="form-group">
								<label for="phone">Phone</label>
								<input type="tel" id="phone" name="_phone" class="form-control"/>
							</div>

							<input type="submit" id="_submit" name="_submit" value="SIGN UP" class="btn btn-light-blue btn-block"/>
						</form>

					</div>
				</div>
			</div>
		</section>
		<script>
			$(document).ready(function(){

				function clear_messages() {
					$('#wait').hide();
					$('#loginmsg').hide();
				}

				clear_messages();

				 $('#_submit').click(function(e) {
					 	e.preventDefault();
					 	clear_messages();
						var url = 'https://localhost:8443/register'
						var email = ($('#email').val() == "" ?  null : $('#email').val())
						var password = ($('#password').val() == "" ?  null : $('#password').val())
                        var firstname = ($('#firstname').val() == "" ?  null : $('#firstname').val())
                        var lastname = ($('#lastname').val() == "" ?  null : $('#lastname').val())
                        var phone = ($('#phone').val() == "" ?  null : $('#phone').val())

						var data = {
							"email": email,
							"password": password,
                            "name": firstname,
                            "surname": lastname,
                            "telNumber": phone,
                            "picture": null
						};

                        console.log(data);

						$.ajax({
							type: "POST",
							url: url,
							contentType: "application/json",
							data: JSON.stringify(data),
							beforeSend: function() {
								$('#wait').show()
							},
							success: function(data, status, $xhr) {
								console.log("Register Successful");
                                var url = 'https://localhost:8443/login'
                                var data = {
                                    "email": data.email,
                                    "password": password
                                };
                                $.ajax({
        							type: "POST",
        							url: url,
        							contentType: "application/json",
        							data: JSON.stringify(data),
        							success: function(data, status, $xhr) {
        								localStorage.isjwt = $xhr.getResponseHeader("Authorization").replace('Bearer ', '');
        								console.log("Login " + localStorage.isjwt);
        								window.location.href = "/#!/home";
        							},
        							error: function($xhr) {
        								clear_messages();
        								delete localStorage.isjwt;
        								if ($xhr.status >= 400 && $xhr.status < 500) {	// Invalid credentials
        									$('#loginmsg').show();
        								}
        							}
        						});
							},
							error: function($xhr) {
								clear_messages();
								if ($xhr.status >= 400 && $xhr.status < 500) {	// Invalid credentials
									$('#loginmsg').show();
								}
							}
						});
				  });
			});
		</script>
	</body>
</html>
